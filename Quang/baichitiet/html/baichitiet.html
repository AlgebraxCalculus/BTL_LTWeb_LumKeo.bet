<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài viết chi tiết</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../../../css/header.css">
    <link rel="stylesheet" href="../../../css/footer.css">
    <link rel="stylesheet" href="../../../css/general.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="../../../Js/Search-header.js" defer></script>
</head>
  <body>
    <header class="navbar">
        <div class="logo">
            <a href="../../../index.html">
                <img src="../image/header-footer-logo/logo-web.png" alt="Ảnh tên web">
            </a>
        </div>
        <nav class="menu">
            <ul>
                <li><a href="../../../index.html">Trang chủ</a></li>
                <li class="dropdown">
                    <a href="#">Giải đấu <i class="fas fa-chevron-down dropdown-icon"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="../../giaidau/html/giaidau-EPL.html">Premier League</a></li>
                        <li><a href="../../giaidau/html/giaidau-LaLiga.html">La Liga</a></li>
                        <li><a href="../../giaidau/html/giaidau-seria.html">Serie A</a></li>
                        <li><a href="../../giaidau/html/giaidau-bundes.html">Bundesliga</a></li>
                        <li><a href="../../giaidau/html/giaidau-l1.html">Ligue 1</a></li>
                        <li><a href="../../giaidau/html/giaidau-vleague.html">V.League 1</a></li>
                    </ul>
                </li>
                <li><a href="#">Bóng đá Việt Nam</a></li>
                <li><a href="#">Bóng đá thế giới</a></li>
            </ul>
        </nav>
        <div class="nav-icons">
            <a class="search-button">
                <img src="../image/header-footer-logo/logo-search.png" alt="Search Icon">
            </a>
            <a class="account-button" href="#">
                <img src="../image/header-footer-logo/avatar.png" alt="User Icon">
            </a>
        </div>
    </header>

<!--search-header section-->
<div class="navbar search-header">
    <div class="logo">
        <a href="/index.html">
            <img src="../image/header-footer-logo/logo-web.png" alt="Ảnh tên web">
        </a>
    </div>
    
    <form class="search-bar">
        <input type="text" id="search-text" placeholder="Nhập nội dung tìm kiếm...">
        <button><img src="../image/header-footer-logo/logo-search.png" alt="Search Icon"></button>
        <div id="dropdown-searchbar" class="dropdown-searchbar"></div>
    </form>

    <div class="nav-icons">
        <a class="search-button">
            <img src="../image/header-footer-logo/logo-search.png" alt="Search Icon">
        </a>
        <a class="account-button" href="#">
            <img src="../image/header-footer-logo/avatar.png" alt="User Icon">
        </a>
    </div>
</div>
    <div class="dark-overlay"></div>

    <div class="container">
        <!-- Cột trái: Bài viết -->
        <div class="content-left">
            <nav class="breadcrumb" id="breadcrumb">
                <ul>
                    <li><a href="#" id="category-link">Đang tải...</a></li>
                </ul>
            </nav>
            <h1 id="article-title">Đang tải...</h1>
            <p id="article-meta"><strong>Đang tải...</strong> - Đang tải...</p>

            <div class="highlight-box">
                <h2 id="article-highlight">Đang tải...</h2>
            </div>

            <div id="article-content">
                <div class="loading">Đang tải nội dung...</div>
            </div>

            <div class="img-container">
                <img id="main-image" src="" class="main-img" alt="">
                <p id="image-caption" class="caption">Đang tải...</p>
            </div>

            <h3 class="kyten" id="author-name">Đang tải...</h3>
        </div>

        <!-- Cột phải: Tin liên quan và tin khác -->
        <div class="content-right">
            <!-- Tin liên quan -->
            <a href="#"><div class="relatednews-titlebox">
                <h4 class="relatednews-title">TIN LIÊN QUAN</h4>
            </div></a>
            <div class="inner-sidebar" id="related-articles">
                <div class="loading">Đang tải...</div>
            </div>
            <!-- TIN KHÁC -->
            <a href="#"><div class="othernews-titlebox">
                <h4 class="othernews-title">TIN KHÁC</h4>
            </div></a>
            <div class="inner-sidebar" id="other-articles">
                <div class="loading">Đang tải...</div>
            </div>
        </div>
    </div>
        <!--Footer-->
        <footer>
            <div class="footer-1st">
                <img class="logo" src="../image/header-footer-logo/logo-web.png" alt="logo website">
                <p class="description">Trang thông tin điện tử tổng hợp về lĩnh vực bóng đá trong nước và thế giới
                </p>
                <i class="fa-brands fa-square-facebook"></i>
                <i class="fa-brands fa-youtube"></i>
            </div>

            <div class="sep-line"></div>

            <div class="footer-2nd">
                <div class="contact">
                    <div class="contact-item">
                        <p class="ct-info">Số điện thoại liên hệ</p>
                        <p class="ct-value">0902170359</p>
                    </div>
                    <div class="contact-item">
                        <p class="ct-info">Email</p>
                        <p class="ct-value">xinmotlanthua.lumkeo@gmail.com</p>
                    </div>
                    <div class="contact-item">
                        <p class="ct-info">Địa chỉ</p>
                        <p class="ct-value">68 - ngõ 203 Kim Ngưu, Hai Bà Trưng, Hà Nội</p>
                    </div>
                    <div class="contact-item boxing">
                        <p class="copyright">Copyright@2025 - BTL thiet ke website LumKeo.bet</p>
                    </div>
                </div>

                <div class="message">
                    <p class="ms-title pacifico-regular">Trang web này chắc chắn không thể hoạt động nếu thiếu đi sự
                        đồng
                        hành của quý độc giả!</p>
                    <div class="ms-donate">
                        <p class="ms-detail pacifico-regular">Trong tương lai, LumKeo.bet sẽ mở rộng thêm các tính
                            năng
                            mới
                            như livescore, dự đoán tỉ số, soi kèo,... cho tới lúc đó, mọi sự ủng hộ của mina đều là
                            động
                            lực
                            lớn lao cho anh em chúng tôi vững bước. Cảm ơn mina rấc nhìuuu!</p>
                        <img src="../image/header-footer-logo/logo-footer.png" alt="creator-avatar">
                        <img src="../image/header-footer-logo/qr-code.png" alt="creator's QR">
                    </div>
                </div>
            </div>
        </footer>
    </div>
    <script>
        // Helper: Get cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // Helper: Decode JWT
        function decodeJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error decoding JWT:', error);
                return null;
            }
        }
        
        // Fetch current user data
        async function getCurrentUser() {
            try {
                const token = getCookie("token");
                console.log('Token:', token);
                if (!token) {
                    throw new Error("Không tìm thấy token, vui lòng đăng nhập!");
                }
        
                const payload = decodeJwt(token);
                if (!payload) {
                    throw new Error("Token không hợp lệ!");
                }
        
                const { id, username, role, avatar } = payload;
                console.log('User ID:', id);
                console.log('User Name:', username);
                console.log('User Role:', role);
                console.log('Full Payload:', payload);
        
                if (!id || !/^[0-9a-fA-F]{24}$/.test(id)) {
                    throw new Error("ID không hợp lệ, phải là ObjectId MongoDB!");
                }
        
                let userData = { id, username, role, avatar };
                try {
                    const res = await fetch(`http://localhost:3000/api/users/${id}?_t=${Date.now()}`, {
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': `Bearer ${token.trim()}`
                        }
                    });
        
                    if (!res.ok) {
                        const errorText = await res.text();
                        console.warn('API Error:', errorText);
                        if (res.status === 403) {
                            console.warn('Permission denied for /api/users/:id, using token data');
                            return userData;
                        } else {
                            throw new Error(`HTTP error! Status: ${res.status} - ${errorText}`);
                        }
                    }
        
                    const contentType = res.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Response is not JSON');
                    }
        
                    const data = await res.json();
                    const user = data.user || data;
                    userData = {
                        id,
                        username: user.username !== undefined ? user.username : username,
                        role: user.role !== undefined ? user.role : role,
                        avatar: user.avatar !== undefined ? user.avatar : avatar
                    };
                } catch (apiError) {
                    console.warn('Falling back to token data due to API error:', apiError);
                    return userData;
                }
        
                return userData;
            } catch (error) {
                console.error('getCurrentUser Error:', error);
                throw error;
            }
        }
        
        // Update account buttons in both main navbar and search-header
        document.addEventListener('DOMContentLoaded', async () => {
            const accountButtons = document.querySelectorAll('.account-button');
        
            try {
                const user = await getCurrentUser();
                console.log('Logged-in user:', user);
        
                // Determine redirect URL based on role using correct relative paths from Quang/baichitiet/
                let redirectUrl;
                switch (user.role) {
                    case 'admin':
                        redirectUrl = '../../../Thuy + DucMinh/ADMIN_QLBB.html';
                        break;
                    case 'author':
                        redirectUrl = '../../../Thuy + DucMinh/AUTHOR_QLBV.html';
                        break;
                    case 'user':
                        redirectUrl = '../../../Thuy + DucMinh/USER_BBDL.html';
                        break;
                    default:
                        alert('Không xác định được quyền truy cập: ' + user.role);
                        redirectUrl = '../../../Hi-Tech/Login.html'; // Fallback to login with relative path
                }
        
                // Update all account buttons to redirect to the appropriate page
                accountButtons.forEach(button => {
                    button.href = redirectUrl;
                    button.addEventListener('click', () => {
                        localStorage.setItem('userInfo', JSON.stringify(user));
                    });
                });
            } catch (error) {
                console.error('User not logged in or error:', error.message);
                // User is not logged in or an error occurred, redirect to login page
                accountButtons.forEach(button => {
                    button.href = '../../../Hi-Tech/Login.html';
                });
            }
        });
        </script>
    <script src="../js/articleDetail.js"></script>
    <script src="../../../Hi-Tech/Login.html"></script>
    
</body>
</html>
